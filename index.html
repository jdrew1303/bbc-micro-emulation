<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Emulating a BBC Micro in Javascript</title>

    <meta name="description" content="Emulating a BBC Micro in Javascript">
    <meta name="author" content="Matt Godbolt">

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/night.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
        if (window.location.search.match(/print-pdf/gi)) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'css/print/pdf.css';
            document.getElementsByTagName('head')[0].appendChild(link);
        }
    </script>
    <style>
        @font-face {
            font-family: 'Teletext';
            src: url('teletext.ttf');
        }

        .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
            font-family: "Teletext", Impact, sans-serif;
        }

        .reveal .teletext {
            font-family: "Teletext", Impact, sans-serif;
        }

        table.horizontal {
            border-collapse: collapse;
        }

        table.horizontal th, table.horizontal td {
            border: 1px solid grey;
            text-align: center;
            width: 6em;
        }

        table.horizontal th:nth-child(even) {
            background-color: #444;
        }

        table.horizontal th:nth-child(odd) {
            background-color: #222;
        }

        table.horizontal td:nth-child(even) {
            background-color: #444;
        }

        table.horizontal td:nth-child(odd) {
            background-color: #222;
        }

        table.memmap {
            width: 100%;
        }

        table.memmap th {
            width: 6em;
            font-family: monospace;
            font-weight: normal;
            text-align: center;
        }

        table.memmap td {
            vertical-align: middle;
        }

        table.memmap tr.osrom {
            background-color: #222244;
        }

        table.memmap tr.hw {
            background-color: #444433;
        }

        table.memmap tr.rom1 {
            background-color: #222233;
        }

        table.memmap tr.ram1 {
            background-color: #223322;
        }

        table.memmap tr.ram2 {
            background-color: #283828;
        }
    </style>
    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

    <div class="slides">
        <section>
            <h1>Emulating a BBC Micro</h1>

            <h2>in Javascript</h2>
            <h5>Trying to recapture a lost youth</h5>

            <p>
                <small><a href="mailto:matt@godbolt.org">Matt Godbolt</a></small>
            </p>
        </section>
        <section>
            <section>
                <h2>What's a BBC Micro?</h2>
                <img class="stretch" src="Beeb.jpeg">
                <ul>
                    <li>BBC Computer Literacy Project</li>
                    <li>1981</li>
                </ul>
            </section>
        </section>
        <section>
            <section>
                <h2>What's in a BBC Micro?</h2>
                <ul>
                    <li>2MHz 6502 CPU</li>
                    <li>32KB RAM / 32KB ROM</li>
                    <li>Memory-mapped hardware:
                        <ul>
                            <li>Video</li>
                            <li>Sound</li>
                            <li>Tape / floppy disc</li>
                            <li>ADC / Econet / 2nd processor</li>
                        </ul>
                    </li>
                    <li>Video hardware
                        <ul>
                            <li>"<span class="teletext">Teletext</span>" character map</li>
                            <li>Various bitmap modes up
                                <ul>
                                    <li>640x256 in 2-colour</li>
                                    <li>160x256 in 8-colour</li>
                                </ul>
                        </ul>
                    </li>
                </ul>
            </section>
        </section>
        <section>
            <h2>What's in a 6502</h2>
            <ul>
                <li>3 general 8-bit registers:
                    <ul>
                        <li><code>A</code> - accumulator</li>
                        <li><code>X</code> - index register</li>
                        <li><code>Y</code> - index register</li>
                    </ul>
                </li>
                <li>2 special 8-bit registers
                    <ul>
                        <li><code>P</code> - flags register</li>
                        <li><code>S</code> - stack pointer</li>
                    </ul>
                <li>16-bit program counter</li>
            </ul>
        </section>
        <section>
            <h2>Example</h2>
                     <pre><code class="asm6502" data-trim>
.strlen                     ; 0x70/0x71 point to string.
                            ; returns length in A (low) and X (high)
a0 00       LDY #0          ; we're going to use Y as the loop counter. Start at 0
a2 00       LDX #0          ; initialize the high part of the length
.lp
b1 70       LDA ($70), Y    ; read the byte pointed to by (0x70/0x71) + Y
f0 09       BEQ end         ; if it's zero, we're at the end of the string
c8          INY             ; otherwise increment the loop counter
d0 f9       BNE lp          ; if it didn't overflow past 0xff to 0, re-loop
e6 71       INC $71         ; else, increment the high part of the address
e8          INX             ; and the X counter
d0 f4       BNE lp          ; and re-loop (NB falling off here would mean &gt; 65536)
.end
98          TYA             ; put the loop counter into A (the low part of the length)
60          RTS             ; and return
                     </code></pre>
        </section>
        <section>
            <h2>Emulating the 6502</h2>
                     <pre><code class="javascript" data-trim>
var a = 0, x = 0, y = 0, s = 0, p = {c:false, z:false /* ... */};
function readbyte(addr) { /* ... */ }
var pc = readbyte(0xfffc) | (readbyte(0xfffd) &lt;&lt; 8);

while (true) {
    var opcode = readbyte(pc); pc++;
    switch (opcode) {
        case 0xa9: /*LDA #xx*/ a = readbyte(pc); pc++; break;
        case 0xa2: /*LDX #xx*/ x = readbyte(pc); pc++; break;
        case 0xa0: /*LDY #xx*/ y = readbyte(pc); pc++; break;
        case 0x98: /*TYA*/ a = y; break;
        case 0x69: /*ADC #xx*/ a += readbyte(pc); pc++; break;
        case 0xb1: /*LDA (xx),Y*/
            zp = readbyte(pc); pc++;
            addr = readbyte(zp) | (readbyte(zp+1)&gt;&gt;8);
            a = readbyte(addr + y);
            break;
        case 0xe8: /*INX*/ x = x + 1; break;
        // and so on...
                     </code></pre>
        </section>
        <section>
            <h2>Except...</h2>
            <ul>
                <li>Setting flags</li>
                <li>Memory access</li>
                <li>Hardware</li>
                <li>Interrupts</li>
                <li>Handling time</li>
            </ul>
        </section>
        <section>
            <section>
                <h2>Memory</h2>
                <table class="memmap">
                    <tbody>
                    <tr class="osrom">
                        <th>0xff00</th>
                        <td>256 bytes OS ROM</td>
                    </tr>
                    <tr class="hw">
                        <th>0xfe00</th>
                        <td>256 bytes hardware</td>
                    </tr>
                    <tr class="osrom">
                        <th>0xfd00</th>
                        <td>256 bytes OS ROM</td>
                    </tr>
                    <tr class="hw">
                        <th>0xfc00</th>
                        <td>256 bytes hardware</td>
                    </tr>
                    <tr class="osrom">
                        <th>&uarr;<br>&uarr;<br>0xc000</th>
                        <td>15.5KB OS ROM</td>
                    </tr>
                    <tr class="rom1">
                        <th>&uarr;<br>&uarr;<br>0x8000</th>
                        <td>16KB Paged ROM</td>
                    </tr>
                    <tr class="ram2">
                        <th>&uarr;<br>&uarr;<br>0x4000</th>
                        <td>16KB RAM</td>
                    </tr>
                    <tr class="ram1">
                        <th>&uarr;<br>&uarr;<br>0x0000</th>
                        <td>16KB RAM</td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section>
                         <pre><code class="javascript" data-trim>
var ram = new Uint8Array(0x8000);
var os = load("OS");
var romsel = 0;
var roms = [];
roms[15] = load("BASIC");

function readmem(addr) {
    if (addr &lt; 0x8000) return ram[addr];
    if (addr &lt; 0xc000) return roms[romsel][addr - 0x8000];
    if ((addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00)
        || (addr &gt;= 0xfc00 &amp;&amp; addr &lt; 0xfd00)) return readhw(addr);
    return os[addr - 0xc000];
}

function writemem(addr, b) {
    if (addr &lt; 0x8000) ram[addr] = b;
    if (addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00) writehw(addr, b);
    // else does nothing - it's ROM
}
                         </code></pre>
            </section>
        </section>
        <section>
            <h2><a href="https://bbc.godbolt.org/?autoboot" target="_blank">Live demo!</a></h2>
        </section>
        <section>
            <section>
                <h2>Performance</h2>
                <ul>
                    <li><code>switch</code> problems</li>
                    <li>Dynamic dispatch</li>
                    <li>Loop unrolling for video</li>
                    <li>Uint32Array for screen</li>
                </ul>
            </section>
            <section>
                <h2>Worth it!</h2>
                <img class="stretch" src="tt26.jpg">

                <p>Also finally hacked Lunar Jetman</p>
            </section>
        </section>
        <section>
            <h2>Any questions?</h2>
            <ul>
                <li><a href="https://bbc.godbolt.org/">https://bbc.godbolt.org/</a></li>
                <li>Source on <a href="https://github.com/mattgodbolt/jsbeeb">github</a></li>
            </ul>
        </section>
    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.min.js"></script>

<script>

    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
            {
                src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            }
            },
            {
                src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            },
            {
                src: 'plugin/zoom-js/zoom.js', async: true, condition: function () {
                return !!document.body.classList;
            }
            },
            {
                src: 'plugin/notes/notes.js', async: true, condition: function () {
                return !!document.body.classList;
            }
            }
        ]
    });

</script>

</body>
</html>
